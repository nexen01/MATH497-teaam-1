install.packages("readr")
install.packages("dplyr")
install.packages("sf")
install.packages("leaflet")
install.packages("stringr")
install.packages("stringdist")
install.packages("party")
install.packages("tigris")
install.packages("rgdal")
install.packages("factoextra")
install.packages("mclust")
install.packages(c("ggplot2", "ggpubr", "tidyverse", "broom", "AICcmodavg"))
install.packages("tidycensus")
install.packages("deldir")
install.packages("request")


library(mclust)
library(factoextra)
library(readr)
library(dplyr)
library(sf)
library(leaflet)
library(stringr)
library(stringdist)
library(party)
library(tigris)
library(sp)
library(rgdal)
library(ggplot2)
library(ggpubr)
library(tidyverse)
library(broom)
library(AICcmodavg)
library(tidycensus)
library(deldir)
library(requests)

options(tigris_use_cache = TRUE)

#Need to save longer decimal points for chr values
options(digits=15)

#Read in lat/lon + lead data files into R 
geocode_lead <- read_csv("https://raw.githubusercontent.com/nexen01/MATH497-teaam-1/main/InitLatLon.csv")

#Seperate column geometry
geocode_lead <- geocode_lead %>%
     separate(Coordinates, into = c('lat', 'long'), sep=",")

#clean up geo code. Remove parathesis
geocode_lead$lat <- gsub("[[]", "", geocode_lead$lat)
geocode_lead$long <- gsub("[]]", "", geocode_lead$long)


#change to numeric values
geocode_lead$lat <- as.numeric(as.character(geocode_lead$lat))
geocode_lead$long <- as.numeric(as.character(geocode_lead$long))

#flip lat long
geocode_lead <- geocode_lead %>% 
        rename("long" = 3,
               "lat" = 4)

# add a column with the corresponding census tract.
#CODE SOURCE: https://stackoverflow.com/questions/51499410/retrieve-census-tract-from-coordinates?noredirect=1&lq=1


#get a map of Illinois' tracts into R
il <- tidycensus::get_acs(state = "IL", geography = "tract",
              variables = "B19013_001", geometry = TRUE)



my_points <- data.frame(
  x = geocode_lead$lat
  y = geocode_lead$long
  %>%
  # convert the points to same CRS
  st_as_sf(coords = c("x", "y"),
           crs = st_crs(il))

geocode_lead$census_code <- apply(geocode_lead, 1, function(row) call_geolocator_latlon(row['lat'], row['long']))


   

geocode_lead_sample <- geocode_lead[sample(nrow(geocode_lead), 500), ]

geocode_lead_sample$census_code <- apply(geocode_lead_sample, 1, function(row) call_geolocator_latlon(row['lat'], row['long']))

illinois <- tracts(state = 'IL')

crswgs84=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
states_shape <- readShapePoly("/home/rstudio/states_21basic/states",proj4string=crswgs84,verbose=TRUE)


Illinois <- tractShp

tractLookup <- function(x) {
  pt <- SpatialPoints(data.frame(x = x$long, y = x$lat))
  Mapping <- over(pt, illinois) # what index number does pt fall inside?
  Mapping <- data.frame(
  "GEOID" = as.character(Mapping$GEOID),
  "State" = as.character(Mapping$STATEFP) , 
  "County" = as.character(Mapping$COUNTYFP), 
  "Tract" = as.character(Mapping$TRACTCE), 
  "Tract_Name" = as.character(Mapping$NAME), 
  "INTPTLAT" = as.character(Mapping$INTPTLAT),
  "INTPTLON" = as.character(Mapping$INTPTLON),
  stringsAsFactors = FALSE)
  Mapping[is.na(Mapping)] <- "NULL"   
return(Mapping)
}

geocode_lead_sample_tract <- tractLookup(spts)



shape_latlong <- apply(gDistance(spts, tractShp,byid=TRUE),2,min)

latlong_values <- geocode_lead_sample[, c("long", "lat")]

latlong_values_round <- latlong_values %>% mutate_if(is.numeric, round, 5)


latlong_values$census_code <- apply(latlong_values, 1, function(row) call_geolocator_latlon(row['long'], row['lat']))



geocode_lead_sample$census_code_new <- apply(geocode_lead_sample, 1, function(row) call_geolocator_latlon(row['long'], row['lat']))

temp_shapefile <- tempfile()
download.file("/Users/RyanCiminski/desktop/tl_2022_17_tract.zip", temp_shapefile)
unzip(temp_shapefile)

census_tracts <- read_sf('/users/ryanciminski/desktop/tl_2022_17_tract.shp')

lead_geos <- geocode_lead_sample[,c("long","lat")] %>%  
  split(1:nrow(geocode_lead_sample)) %>% ##split each row into its own list, 
  lapply(FUN=function(x){as.numeric(x) %>% st_point()}) %>%  
  st_sfc(crs = "+proj=longlat +datum=WGS84")
  

latlong_sf <- geocode_lead_sample %>%
  filter(!is.na(lat), !is.na(long)) %>%
  st_as_sf(coords = c("long", "lat"), crs = st_crs(census_tracts))

system.time({
  intersected <- st_intersects(latlong_sf, census_tracts)
})

latlong_final <- latlong_sf %>%
  mutate(intersection = as.integer(intersected),
         fips = if_else(is.na(intersection), "",
                        census_tracts$GEOID[intersection]))
head(latlong_final)

